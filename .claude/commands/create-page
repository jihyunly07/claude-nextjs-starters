#!/bin/bash

# 페이지 생성 커맨드 (레이아웃별)
# 사용법: create-page <name> [--layout marketing|dashboard|auth] [--with-form] [--with-table]
# 예: create-page products --layout dashboard --with-table

set -e

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 기본값
LAYOUT="marketing"
WITH_FORM=false
WITH_TABLE=false

# 인자 파싱
if [ -z "$1" ]; then
  echo -e "${RED}오류: 페이지 이름을 입력해주세요.${NC}"
  echo "사용법: create-page <name> [--layout marketing|dashboard|auth] [--with-form] [--with-table]"
  echo ""
  echo "옵션:"
  echo "  --layout <type>  레이아웃 선택 (marketing, dashboard, auth, 기본값: marketing)"
  echo "  --with-form      폼 포함"
  echo "  --with-table     데이터 테이블 포함"
  echo ""
  echo "예시:"
  echo "  create-page products --layout dashboard --with-table"
  echo "  create-page contact --layout marketing --with-form"
  exit 1
fi

NAME=$1
shift

# 옵션 파싱
while [[ $# -gt 0 ]]; do
  case $1 in
    --layout)
      LAYOUT="$2"
      shift 2
      ;;
    --with-form)
      WITH_FORM=true
      shift
      ;;
    --with-table)
      WITH_TABLE=true
      shift
      ;;
    *)
      echo -e "${RED}오류: 알 수 없는 옵션 $1${NC}"
      exit 1
      ;;
  esac
done

# 레이아웃 검증
if [[ ! "$LAYOUT" =~ ^(marketing|dashboard|auth)$ ]]; then
  echo -e "${RED}오류: 레이아웃은 marketing, dashboard, auth 중 하나여야 합니다.${NC}"
  exit 1
fi

# 입력 검증 (보안: 경로 인젝션 방지)
if [[ ! "$NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
  echo -e "${RED}오류: 이름에는 영문자, 숫자, 하이픈, 언더스코어만 사용 가능합니다.${NC}"
  exit 1
fi

# 경로 트래버설 방지
if [[ "$NAME" == *".."* ]] || [[ "$NAME" == "/"* ]]; then
  echo -e "${RED}오류: 유효하지 않은 이름입니다.${NC}"
  exit 1
fi

# kebab-case로 변환
KEBAB_NAME=$(echo "$NAME" | sed 's/\([A-Z]\)/-\1/g' | sed 's/^-//' | tr '[:upper:]' '[:lower:]')
# PascalCase로 변환 (kebab-case에서)
PASCAL_NAME=$(echo "$KEBAB_NAME" | perl -pe 's/(^|-)(.)/\U$2/g')

# 파일 경로
PAGE_DIR="src/app/(${LAYOUT})/${KEBAB_NAME}"
PAGE_PATH="${PAGE_DIR}/page.tsx"

# 디렉토리 확인
if [ ! -d "src/app/(${LAYOUT})" ]; then
  echo -e "${RED}오류: src/app/(${LAYOUT}) 폴더를 찾을 수 없습니다.${NC}"
  exit 1
fi

# 디렉토리 생성
if [ -d "$PAGE_DIR" ]; then
  echo -e "${YELLOW}경고: ${PAGE_DIR} 폴더가 이미 존재합니다.${NC}"
  read -p "덮어쓰시겠습니까? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "취소되었습니다."
    exit 0
  fi
fi

mkdir -p "$PAGE_DIR"

# 페이지 타입별 생성
if [ "$WITH_TABLE" = true ]; then
  # 테이블 포함 페이지 (대시보드용)
  echo -e "${BLUE}📝 테이블 페이지 생성 중...${NC}"
  cat > "$PAGE_PATH" << EOF
/**
 * ${PASCAL_NAME} 관리 페이지
 */

'use client';

import { useState, useEffect } from 'react';
import { Container } from '@/components/layout/container';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Plus } from 'lucide-react';
import { DataTable } from '@/components/tables/data-table';
import { LoadingSpinner } from '@/components/common/loading-spinner';
import { toast } from 'sonner';

// TODO: 실제 타입 import
interface ${PASCAL_NAME}Item {
  id: string;
  name: string;
  createdAt: string;
}

export default function ${PASCAL_NAME}Page() {
  const [data, setData] = useState<${PASCAL_NAME}Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [dialogOpen, setDialogOpen] = useState(false);

  const loadData = async () => {
    try {
      setLoading(true);
      // TODO: API 호출
      await new Promise((resolve) => setTimeout(resolve, 1000));
      setData([]);
    } catch (error) {
      toast.error('데이터를 불러오는데 실패했습니다.', {
        description: error instanceof Error ? error.message : '다시 시도해주세요.',
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  const handleAdd = () => {
    setDialogOpen(true);
  };

  const handleDelete = async (id: string) => {
    if (!confirm('정말 삭제하시겠습니까?')) {
      return;
    }

    try {
      // TODO: API 호출
      toast.success('삭제되었습니다.');
      loadData();
    } catch (error) {
      toast.error('삭제에 실패했습니다.');
    }
  };

  // TODO: 컬럼 정의
  const columns = [
    {
      accessorKey: 'name',
      header: '이름',
    },
    {
      accessorKey: 'createdAt',
      header: '생성일',
    },
  ];

  return (
    <Container className="py-8">
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">${PASCAL_NAME}</h1>
            <p className="text-muted-foreground mt-2">
              ${PASCAL_NAME} 관리 페이지입니다.
            </p>
          </div>
          <Button onClick={handleAdd}>
            <Plus className="mr-2 h-4 w-4" />
            추가하기
          </Button>
        </div>

        <Card className="p-6">
          {loading ? (
            <div className="flex items-center justify-center h-64">
              <LoadingSpinner size="lg" />
            </div>
          ) : (
            <DataTable
              columns={columns}
              data={data}
              searchKey="name"
              searchPlaceholder="검색..."
            />
          )}
        </Card>
      </div>
    </Container>
  );
}
EOF

elif [ "$WITH_FORM" = true ]; then
  # 폼 포함 페이지
  echo -e "${BLUE}📝 폼 페이지 생성 중...${NC}"
  cat > "$PAGE_PATH" << EOF
/**
 * ${PASCAL_NAME} 페이지
 */

'use client';

import { Container } from '@/components/layout/container';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { toast } from 'sonner';

// TODO: 실제 폼 컴포넌트 import
// import { ${PASCAL_NAME}Form } from '@/components/forms/${KEBAB_NAME}-form';

export default function ${PASCAL_NAME}Page() {
  const handleSuccess = (data: unknown) => {
    console.log('Form submitted:', data);
    toast.success('저장되었습니다.');
  };

  const handleError = (error: Error) => {
    console.error('Form error:', error);
    toast.error('저장에 실패했습니다.', {
      description: error.message,
    });
  };

  return (
    <Container className="py-8">
      <div className="max-w-2xl mx-auto space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">${PASCAL_NAME}</h1>
          <p className="text-muted-foreground mt-2">
            정보를 입력해주세요.
          </p>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>${PASCAL_NAME} 정보</CardTitle>
            <CardDescription>
              필수 정보를 입력해주세요.
            </CardDescription>
          </CardHeader>
          <CardContent>
            {/* TODO: 폼 컴포넌트 추가 */}
            {/* <${PASCAL_NAME}Form */}
            {/*   onSuccess={handleSuccess} */}
            {/*   onError={handleError} */}
            {/* /> */}
            <p className="text-muted-foreground text-sm">
              폼 컴포넌트를 추가하세요.
            </p>
          </CardContent>
        </Card>
      </div>
    </Container>
  );
}
EOF

else
  # 기본 페이지
  echo -e "${BLUE}📝 기본 페이지 생성 중...${NC}"

  if [ "$LAYOUT" = "marketing" ]; then
    # 마케팅 페이지
    cat > "$PAGE_PATH" << EOF
/**
 * ${PASCAL_NAME} 페이지
 */

import { Container } from '@/components/layout/container';

export default function ${PASCAL_NAME}Page() {
  return (
    <Container className="py-16">
      <div className="max-w-4xl mx-auto space-y-8">
        {/* 페이지 헤더 */}
        <div className="text-center space-y-4">
          <h1 className="text-4xl font-bold tracking-tight sm:text-5xl">
            ${PASCAL_NAME}
          </h1>
          <p className="text-xl text-muted-foreground">
            페이지 설명을 입력하세요.
          </p>
        </div>

        {/* 콘텐츠 영역 */}
        <div className="prose prose-gray dark:prose-invert max-w-none">
          <p>
            콘텐츠를 추가하세요.
          </p>
        </div>
      </div>
    </Container>
  );
}
EOF

  elif [ "$LAYOUT" = "dashboard" ]; then
    # 대시보드 페이지
    cat > "$PAGE_PATH" << EOF
/**
 * ${PASCAL_NAME} 페이지
 */

import { Container } from '@/components/layout/container';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export default function ${PASCAL_NAME}Page() {
  return (
    <Container className="py-8">
      <div className="space-y-6">
        {/* 페이지 헤더 */}
        <div>
          <h1 className="text-3xl font-bold tracking-tight">${PASCAL_NAME}</h1>
          <p className="text-muted-foreground mt-2">
            페이지 설명을 입력하세요.
          </p>
        </div>

        {/* 콘텐츠 영역 */}
        <Card>
          <CardHeader>
            <CardTitle>제목</CardTitle>
            <CardDescription>설명</CardDescription>
          </CardHeader>
          <CardContent>
            <p>콘텐츠를 추가하세요.</p>
          </CardContent>
        </Card>
      </div>
    </Container>
  );
}
EOF

  else
    # Auth 페이지
    cat > "$PAGE_PATH" << EOF
/**
 * ${PASCAL_NAME} 페이지
 */

export default function ${PASCAL_NAME}Page() {
  return (
    <div className="flex min-h-[calc(100vh-4rem)] items-center justify-center">
      <div className="w-full max-w-md space-y-8 p-8">
        <div className="text-center">
          <h1 className="text-2xl font-bold tracking-tight">
            ${PASCAL_NAME}
          </h1>
          <p className="text-muted-foreground mt-2">
            페이지 설명을 입력하세요.
          </p>
        </div>

        {/* 콘텐츠 영역 */}
        <div>
          <p>콘텐츠를 추가하세요.</p>
        </div>
      </div>
    </div>
  );
}
EOF
  fi
fi

echo -e "${GREEN}✓ ${PAGE_PATH} 생성 완료${NC}"

# 완료 메시지
echo ""
echo -e "${GREEN}🎉 페이지 생성이 완료되었습니다!${NC}"
echo ""
echo "생성된 파일:"
echo "  • $PAGE_PATH"
echo ""
echo "레이아웃: (${LAYOUT})"
echo "경로: /${KEBAB_NAME}"
echo ""

if [ "$WITH_TABLE" = true ]; then
  echo "다음 단계:"
  echo "  1. 타입 정의 추가"
  echo "  2. 컬럼 정의 추가"
  echo "  3. API 연동"
  echo "  4. 다이얼로그 컴포넌트 추가 (선택사항)"
elif [ "$WITH_FORM" = true ]; then
  echo "다음 단계:"
  echo "  1. create-form 명령어로 폼 생성"
  echo "  2. 폼 컴포넌트 import 추가"
  echo "  3. API 연동"
else
  echo "다음 단계:"
  echo "  1. 페이지 콘텐츠 추가"
  echo "  2. 필요한 컴포넌트 import"
  echo "  3. 스타일 조정"
fi
