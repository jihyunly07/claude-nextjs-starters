#!/bin/bash

# í¼ ì»´í¬ë„ŒíŠ¸ + Zod ìŠ¤í‚¤ë§ˆ ìƒì„± ì»¤ë§¨ë“œ
# ì‚¬ìš©ë²•: create-form <name>
# ì˜ˆ: create-form product

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ì¸ì í™•ì¸
if [ -z "$1" ]; then
  echo -e "${RED}ì˜¤ë¥˜: í¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
  echo "ì‚¬ìš©ë²•: create-form <name>"
  echo "ì˜ˆ: create-form product"
  exit 1
fi

NAME=$1
# kebab-caseë¡œ ë³€í™˜
KEBAB_NAME=$(echo "$NAME" | sed 's/\([A-Z]\)/-\1/g' | sed 's/^-//' | tr '[:upper:]' '[:lower:]')
# PascalCaseë¡œ ë³€í™˜ (kebab-caseì—ì„œ)
PASCAL_NAME=$(echo "$KEBAB_NAME" | perl -pe 's/(^|-)(.)/\U$2/g')

# íŒŒì¼ ê²½ë¡œ
VALIDATOR_PATH="src/lib/validators/${KEBAB_NAME}.ts"
FORM_PATH="src/components/forms/${KEBAB_NAME}-form.tsx"

# ë””ë ‰í† ë¦¬ í™•ì¸
if [ ! -d "src/lib/validators" ]; then
  echo -e "${RED}ì˜¤ë¥˜: src/lib/validators í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
  exit 1
fi

if [ ! -d "src/components/forms" ]; then
  echo -e "${RED}ì˜¤ë¥˜: src/components/forms í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
  exit 1
fi

# íŒŒì¼ ì¤‘ë³µ í™•ì¸
if [ -f "$VALIDATOR_PATH" ]; then
  echo -e "${YELLOW}ê²½ê³ : ${VALIDATOR_PATH} íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.${NC}"
  read -p "ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 0
  fi
fi

if [ -f "$FORM_PATH" ]; then
  echo -e "${YELLOW}ê²½ê³ : ${FORM_PATH} íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.${NC}"
  read -p "ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 0
  fi
fi

# Zod ìŠ¤í‚¤ë§ˆ ìƒì„±
echo -e "${GREEN}ğŸ“ Zod ìŠ¤í‚¤ë§ˆ ìƒì„± ì¤‘...${NC}"
cat > "$VALIDATOR_PATH" << EOF
/**
 * ${PASCAL_NAME} ê´€ë ¨ ìœ íš¨ì„± ê²€ì¦ ìŠ¤í‚¤ë§ˆ
 * Zodë¥¼ ì‚¬ìš©í•œ íƒ€ì… ì•ˆì „í•œ ê²€ì¦
 */

import { z } from 'zod';

/**
 * ${PASCAL_NAME} ìƒì„±/ìˆ˜ì • ìŠ¤í‚¤ë§ˆ
 */
export const ${NAME}Schema = z.object({
  name: z
    .string()
    .min(1, 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    .max(100, 'ì´ë¦„ì€ ìµœëŒ€ 100ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.'),
  description: z
    .string()
    .max(500, 'ì„¤ëª…ì€ ìµœëŒ€ 500ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.')
    .optional(),
});

/**
 * íƒ€ì… ì¶”ì¶œ
 */
export type ${PASCAL_NAME}Input = z.infer<typeof ${NAME}Schema>;
EOF

echo -e "${GREEN}âœ“ ${VALIDATOR_PATH} ìƒì„± ì™„ë£Œ${NC}"

# í¼ ì»´í¬ë„ŒíŠ¸ ìƒì„±
echo -e "${GREEN}ğŸ“ í¼ ì»´í¬ë„ŒíŠ¸ ìƒì„± ì¤‘...${NC}"
cat > "$FORM_PATH" << EOF
/**
 * ${PASCAL_NAME} ìƒì„±/ìˆ˜ì • í¼ ì»´í¬ë„ŒíŠ¸
 */

'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Button } from '@/components/ui/button';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { ${NAME}Schema, type ${PASCAL_NAME}Input } from '@/lib/validators/${KEBAB_NAME}';
import { LoadingSpinner } from '@/components/common/loading-spinner';

interface ${PASCAL_NAME}FormProps {
  /**
   * ì´ˆê¸° ë°ì´í„° (ìˆ˜ì • ëª¨ë“œ)
   */
  initialData?: ${PASCAL_NAME}Input;
  /**
   * ì œì¶œ ì„±ê³µ ì½œë°±
   */
  onSuccess?: (data: ${PASCAL_NAME}Input) => void;
  /**
   * ì œì¶œ ì‹¤íŒ¨ ì½œë°±
   */
  onError?: (error: Error) => void;
  /**
   * ì œì¶œ ë²„íŠ¼ í…ìŠ¤íŠ¸
   */
  submitText?: string;
}

export function ${PASCAL_NAME}Form({
  initialData,
  onSuccess,
  onError,
  submitText = 'ì €ì¥í•˜ê¸°',
}: ${PASCAL_NAME}FormProps) {
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<${PASCAL_NAME}Input>({
    resolver: zodResolver(${NAME}Schema),
    defaultValues: initialData || {
      name: '',
      description: '',
    },
  });

  const onSubmit = async (data: ${PASCAL_NAME}Input) => {
    try {
      setIsLoading(true);
      // TODO: API í˜¸ì¶œ ë¡œì§ ì¶”ê°€
      await new Promise((resolve) => setTimeout(resolve, 1000)); // ì„ì‹œ ë”œë ˆì´
      onSuccess?.(data);
    } catch (error) {
      onError?.(error as Error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>ì´ë¦„</FormLabel>
              <FormControl>
                <Input
                  placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                  {...field}
                  disabled={isLoading}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="description"
          render={({ field }) => (
            <FormItem>
              <FormLabel>ì„¤ëª…</FormLabel>
              <FormControl>
                <Textarea
                  placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                  {...field}
                  disabled={isLoading}
                  rows={4}
                />
              </FormControl>
              <FormDescription>
                ì„ íƒ ì‚¬í•­ì…ë‹ˆë‹¤.
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        <div className="flex justify-end gap-2">
          <Button type="submit" disabled={isLoading}>
            {isLoading ? <LoadingSpinner size="sm" /> : submitText}
          </Button>
        </div>
      </form>
    </Form>
  );
}
EOF

echo -e "${GREEN}âœ“ ${FORM_PATH} ìƒì„± ì™„ë£Œ${NC}"

# ì™„ë£Œ ë©”ì‹œì§€
echo ""
echo -e "${GREEN}ğŸ‰ í¼ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
echo ""
echo "ìƒì„±ëœ íŒŒì¼:"
echo "  â€¢ $VALIDATOR_PATH"
echo "  â€¢ $FORM_PATH"
echo ""
echo "ë‹¤ìŒ ë‹¨ê³„:"
echo "  1. ${VALIDATOR_PATH}ì—ì„œ í•„ë“œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”"
echo "  2. ${FORM_PATH}ì—ì„œ í¼ í•„ë“œë¥¼ ì¶”ê°€/ìˆ˜ì •í•˜ì„¸ìš”"
echo "  3. onSubmit í•¨ìˆ˜ì— API í˜¸ì¶œ ë¡œì§ì„ ì¶”ê°€í•˜ì„¸ìš”"
